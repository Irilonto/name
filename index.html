<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–æ–Ω–∏–º–Ω—ã–π —á–∞—Ç | –ü–æ–¥–∫–ª—é—á–∏—Å—å –∫ –±–µ—Å–µ–¥–µ</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ ngrok
        fetch(window.location.href, {
            headers: { 'ngrok-skip-browser-warning': 'telegram-webapp' }
        }).catch(() => {});
    </script>
</head>
<body class="theme-transition">
    <div class="container">
        <!-- –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
        <div class="page active" id="homePage">
            <header class="header">
                <h1>–ê–Ω–æ–Ω–∏–º–Ω—ã–π –ß–∞—Ç</h1>
                <p>–û–±—â–∞–π—Ç–µ—Å—å –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –∏ —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –∞–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç—å</p>
            </header>

            <main class="main-content">
                <div class="theme-selector">
                    <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –æ–±—â–µ–Ω–∏—è:</h2>
                    <div class="themes-grid">
                        <div class="theme-card selected" data-topic="general">
                            <div class="theme-icon">üí¨</div>
                            <h3>–û–±—â–µ–µ</h3>
                            <p>–°–≤–æ–±–æ–¥–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ –Ω–∞ –ª—é–±—ã–µ —Ç–µ–º—ã</p>
                        </div>
                        <div class="theme-card" data-topic="love">
                            <div class="theme-icon">‚ù§Ô∏è</div>
                            <h3>–ó–Ω–∞–∫–æ–º—Å—Ç–≤–∞</h3>
                            <p>–ù–∞–π–¥–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –ª—é–¥–µ–π</p>
                        </div>
                        <div class="theme-card" data-topic="games">
                            <div class="theme-icon">üéÆ</div>
                            <h3>–ò–≥—Ä—ã</h3>
                            <p>–û–±—Å—É–∂–¥–µ–Ω–∏–µ –∏–≥—Ä –∏ –ø–æ–∏—Å–∫ –∫–æ–º–ø–∞–Ω–∏–π</p>
                        </div>
                        <div class="theme-card" data-topic="tech">
                            <div class="theme-icon">üíª</div>
                            <h3>–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</h3>
                            <p>IT, –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ, –≥–∞–¥–∂–µ—Ç—ã</p>
                        </div>
                    </div>
                </div>

                <button id="startChatBtn" class="primary-btn">–ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</button>
            </main>
        </div>

        <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
        <div class="page" id="profilePage">
            <header class="header">
                <h1>–ú–æ–π –ü—Ä–æ—Ñ–∏–ª—å</h1>
                <p>–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</p>
            </header>

            <main class="main-content">
                <div class="profile-info">
                    <div class="avatar">üë§</div>
                    <h2>–ê–Ω–æ–Ω–∏–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h2>
                    <p>ID: <span id="userId">123456789</span></p>
                    
                    <div class="stats">
                        <div class="stat-item">
                            <span class="stat-value" id="chatsCount">42</span>
                            <span class="stat-label">–ß–∞—Ç–æ–≤</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="rating">4.8</span>
                            <span class="stat-label">–†–µ–π—Ç–∏–Ω–≥</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="onlineTime">127</span>
                            <span class="stat-label">–ß–∞—Å–æ–≤</span>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
        <div class="page" id="settingsPage">
            <header class="header">
                <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
                <p>–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å–≤–æ–π –æ–ø—ã—Ç</p>
            </header>

            <main class="main-content">
                <div class="settings-list">
                    <div class="setting-item">
                        <span>–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</span>
                        <label class="switch">
                            <input type="checkbox" id="darkThemeToggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                        <label class="switch">
                            <input type="checkbox" id="notificationsToggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span>–ó–≤—É–∫–∏</span>
                        <label class="switch">
                            <input type="checkbox" id="soundsToggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span>–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</span>
                        <button class="small-btn" id="clearHistoryBtn">–û—á–∏—Å—Ç–∏—Ç—å</button>
                    </div>
                </div>
            </main>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã -->
        <div class="theme-switcher" id="themeSwitcher">
            üåì
        </div>

        <footer class="footer">
            <nav>
                <button class="nav-btn active" data-page="home">üè†</button>
                <button class="nav-btn" data-page="profile">üë§</button>
                <button class="nav-btn" data-page="settings">‚öôÔ∏è</button>
            </nav>
        </footer>
    </div>

    <!-- –û–≤–µ—Ä–ª–µ–π –ø–æ–∏—Å–∫–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loader"></div>
            <p>–ò—â–µ–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...</p>
            <button id="cancelSearchBtn" class="secondary-btn">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —á–∞—Ç–∞ -->
    <div class="chat-screen" id="chatScreen">
        <div class="chat-header">
            <button id="backToMainBtn" class="back-btn">‚Üê</button>
            <h3>–ê–Ω–æ–Ω–∏–º–Ω—ã–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫</h3>
            <button id="reportBtn" class="report-btn">‚ö†Ô∏è</button>
        </div>
        <div class="messages-container" id="messagesContainer"></div>
        <div class="message-input">
            <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
            <button id="sendMessageBtn" class="send-btn">‚û§</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tg = window.Telegram.WebApp;
            tg.expand();
            tg.enableClosingConfirmation();

            // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            const state = {
                selectedTopic: 'general',
                currentChatId: null,
                isDarkTheme: true // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–µ–º–Ω–∞—è —Ç–µ–º–∞
            };

            // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
            const elements = {
                startChatBtn: document.getElementById('startChatBtn'),
                cancelSearchBtn: document.getElementById('cancelSearchBtn'),
                loadingOverlay: document.getElementById('loadingOverlay'),
                themeCards: document.querySelectorAll('.theme-card'),
                chatScreen: document.getElementById('chatScreen'),
                backToMainBtn: document.getElementById('backToMainBtn'),
                sendMessageBtn: document.getElementById('sendMessageBtn'),
                messageInput: document.getElementById('messageInput'),
                messagesContainer: document.getElementById('messagesContainer'),
                pages: {
                    home: document.getElementById('homePage'),
                    profile: document.getElementById('profilePage'),
                    settings: document.getElementById('settingsPage')
                },
                darkThemeToggle: document.getElementById('darkThemeToggle'),
                themeSwitcher: document.getElementById('themeSwitcher'),
                userIdElement: document.getElementById('userId')
            };

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            function init() {
                setupEventListeners();
                loadUserData();
                applySavedTheme();
            }

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            function setupEventListeners() {
                // –í—ã–±–æ—Ä —Ç–µ–º—ã —á–∞—Ç–∞
                elements.themeCards.forEach(card => {
                    card.addEventListener('click', () => {
                        elements.themeCards.forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');
                        state.selectedTopic = card.dataset.topic;
                    });
                });

                // –ß–∞—Ç –¥–µ–π—Å—Ç–≤–∏—è
                elements.startChatBtn.addEventListener('click', startSearch);
                elements.cancelSearchBtn.addEventListener('click', cancelSearch);
                elements.backToMainBtn.addEventListener('click', leaveChat);
                elements.sendMessageBtn.addEventListener('click', sendMessage);
                elements.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') sendMessage();
                });

                // –ù–∞–≤–∏–≥–∞—Ü–∏—è
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.addEventListener('click', () => navigate(btn.dataset.page));
                });

                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                elements.darkThemeToggle.addEventListener('change', toggleTheme);
                elements.themeSwitcher.addEventListener('click', toggleTheme);
            }

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            function loadUserData() {
                if (tg.initDataUnsafe?.user) {
                    elements.userIdElement.textContent = tg.initDataUnsafe.user.id;
                }
            }

            // –ü–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
            function startSearch() {
                showLoading(true);
                tg.sendData(JSON.stringify({
                    action: 'search_partner',
                    topic: state.selectedTopic,
                    user_id: tg.initDataUnsafe?.user?.id
                }));
            }

            // –û—Ç–º–µ–Ω–∞ –ø–æ–∏—Å–∫–∞
            function cancelSearch() {
                showLoading(false);
                tg.sendData(JSON.stringify({ action: 'cancel_search' }));
            }

            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
            function sendMessage() {
                const message = elements.messageInput.value.trim();
                if (message && state.currentChatId) {
                    tg.sendData(JSON.stringify({
                        action: 'send_message',
                        chat_id: state.currentChatId,
                        text: message
                    }));
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                    const messageElement = document.createElement('div');
                    messageElement.className = 'message my-message';
                    messageElement.innerHTML = `
                        <div class="message-content">${message}</div>
                        <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    `;
                    elements.messagesContainer.appendChild(messageElement);
                    
                    elements.messageInput.value = '';
                    elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
                }
            }

            // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º
            function navigate(pageName) {
                Object.values(elements.pages).forEach(page => page.classList.remove('active'));
                elements.pages[pageName].classList.add('active');
                
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.page === pageName);
                });
            }

            // –í—ã—Ö–æ–¥ –∏–∑ —á–∞—Ç–∞
            function leaveChat() {
                elements.chatScreen.style.display = 'none';
                navigate('home');
                tg.sendData(JSON.stringify({ action: 'leave_chat' }));
            }

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
            function toggleTheme() {
                state.isDarkTheme = !state.isDarkTheme;
                localStorage.setItem('darkTheme', state.isDarkTheme);
                applyTheme();
            }

            // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã
            function applyTheme() {
                document.body.classList.toggle('light-theme', !state.isDarkTheme);
                elements.darkThemeToggle.checked = state.isDarkTheme;
            }

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Ç–µ–º—ã
            function applySavedTheme() {
                const savedTheme = localStorage.getItem('darkTheme');
                if (savedTheme !== null) {
                    state.isDarkTheme = savedTheme === 'true';
                }
                applyTheme();
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
            function showLoading(show) {
                elements.loadingOverlay.style.display = show ? 'flex' : 'none';
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –±–æ—Ç–∞
            Telegram.WebApp.onEvent('messageReceived', (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.action === 'chat_started') {
                        state.currentChatId = data.chat_id;
                        showLoading(false);
                        elements.chatScreen.style.display = 'flex';
                    }
                    else if (data.action === 'new_message') {
                        const messageElement = document.createElement('div');
                        messageElement.className = 'message partner-message';
                        messageElement.innerHTML = `
                            <div class="message-content">${data.text}</div>
                            <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                        `;
                        elements.messagesContainer.appendChild(messageElement);
                        elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
                    }
                    else if (data.action === 'chat_ended') {
                        tg.showPopup({
                            title: '–ß–∞—Ç –∑–∞–≤–µ—Ä—à–µ–Ω',
                            message: '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç',
                            buttons: [{ type: 'ok' }]
                        });
                        elements.chatScreen.style.display = 'none';
                        navigate('home');
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', e);
                    tg.showAlert(`–û—à–∏–±–∫–∞: ${e.message}`);
                }
            });

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            init();
        });
    </script>
</body>
</html>
