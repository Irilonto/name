<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–æ–Ω–∏–º–Ω—ã–π —á–∞—Ç | –ü–æ–¥–∫–ª—é—á–∏—Å—å –∫ –±–µ—Å–µ–¥–µ</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ ngrok
        fetch(window.location.href, {
            headers: { 'ngrok-skip-browser-warning': 'telegram-webapp' }
        }).catch(() => {});
    </script>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>–ê–Ω–æ–Ω–∏–º–Ω—ã–π –ß–∞—Ç</h1>
            <p>–û–±—â–∞–π—Ç–µ—Å—å –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –∏ —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –∞–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç—å</p>
        </header>

        <main class="main-content">
            <!-- –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
            <div class="page active" id="homePage">
                <div class="theme-selector">
                    <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –æ–±—â–µ–Ω–∏—è:</h2>
                    <div class="themes-grid">
                        <div class="theme-card selected" data-topic="general">
                            <div class="theme-icon">üí¨</div>
                            <h3>–û–±—â–µ–µ</h3>
                            <p>–°–≤–æ–±–æ–¥–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ –Ω–∞ –ª—é–±—ã–µ —Ç–µ–º—ã</p>
                        </div>
                        <div class="theme-card" data-topic="love">
                            <div class="theme-icon">‚ù§Ô∏è</div>
                            <h3>–ó–Ω–∞–∫–æ–º—Å—Ç–≤–∞</h3>
                            <p>–ù–∞–π–¥–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –ª—é–¥–µ–π</p>
                        </div>
                        <div class="theme-card" data-topic="games">
                            <div class="theme-icon">üéÆ</div>
                            <h3>–ò–≥—Ä—ã</h3>
                            <p>–û–±—Å—É–∂–¥–µ–Ω–∏–µ –∏–≥—Ä –∏ –ø–æ–∏—Å–∫ –∫–æ–º–ø–∞–Ω–∏–π</p>
                        </div>
                        <div class="theme-card" data-topic="tech">
                            <div class="theme-icon">üíª</div>
                            <h3>–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</h3>
                            <p>IT, –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ, –≥–∞–¥–∂–µ—Ç—ã</p>
                        </div>
                    </div>
                </div>
                <button id="startChatBtn" class="primary-btn">–ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</button>
            </div>

            <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
            <div class="page" id="profilePage">
                <div class="profile-info">
                    <div class="avatar">üë§</div>
                    <h2>–ê–Ω–æ–Ω–∏–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h2>
                    <p>–í–∞—à ID: <span id="userId">–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω</span></p>
                    
                    <div class="stats">
                        <div class="stat-item">
                            <span class="stat-value" id="chatsCount">0</span>
                            <span class="stat-label">–ß–∞—Ç–æ–≤</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="messagesCount">0</span>
                            <span class="stat-label">–°–æ–æ–±—â–µ–Ω–∏–π</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
            <div class="page" id="settingsPage">
                <div class="settings-list">
                    <div class="setting-item">
                        <span>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                        <label class="switch">
                            <input type="checkbox" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span>–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</span>
                        <label class="switch">
                            <input type="checkbox" id="darkThemeToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span>–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</span>
                        <button class="small-btn" id="aboutBtn">–ò–Ω—Ñ–æ</button>
                    </div>
                </div>
            </div>
        </main>

        <footer class="footer">
            <nav>
                <button class="nav-btn active" data-page="home">üè†</button>
                <button class="nav-btn" data-page="profile">üë§</button>
                <button class="nav-btn" data-page="settings">‚öôÔ∏è</button>
            </nav>
        </footer>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loader"></div>
            <p>–ò—â–µ–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...</p>
            <button id="cancelSearchBtn" class="secondary-btn">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div class="chat-screen" id="chatScreen">
        <div class="chat-header">
            <button id="backToMainBtn" class="back-btn">‚Üê</button>
            <h3>–ê–Ω–æ–Ω–∏–º–Ω—ã–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫</h3>
            <button id="reportBtn" class="report-btn">‚ö†Ô∏è</button>
        </div>
        <div class="messages-container" id="messagesContainer"></div>
        <div class="message-input">
            <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
            <button id="sendMessageBtn" class="send-btn">‚û§</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tg = window.Telegram.WebApp;
            tg.expand();
            tg.enableClosingConfirmation();

            // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            const startChatBtn = document.getElementById('startChatBtn');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const chatScreen = document.getElementById('chatScreen');
            const backToMainBtn = document.getElementById('backToMainBtn');
            const sendMessageBtn = document.getElementById('sendMessageBtn');
            const messageInput = document.getElementById('messageInput');
            const messagesContainer = document.getElementById('messagesContainer');
            const themeCards = document.querySelectorAll('.theme-card');
            const cancelSearchBtn = document.getElementById('cancelSearchBtn');
            const navButtons = document.querySelectorAll('.nav-btn');
            const pages = {
                home: document.getElementById('homePage'),
                profile: document.getElementById('profilePage'),
                settings: document.getElementById('settingsPage')
            };
            const darkThemeToggle = document.getElementById('darkThemeToggle');
            const aboutBtn = document.getElementById('aboutBtn');
            const userIdElement = document.getElementById('userId');

            let selectedTopic = 'general';
            let currentChatId = null;

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª—è
            if (tg.initDataUnsafe?.user?.id) {
                userIdElement.textContent = tg.initDataUnsafe.user.id;
            }

            // –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const pageName = button.dataset.page;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    Object.values(pages).forEach(page => page.classList.remove('active'));
                    pages[pageName].classList.add('active');
                });
            });

            // –¢–µ–º–Ω–∞—è —Ç–µ–º–∞
            if (darkThemeToggle) {
                darkThemeToggle.addEventListener('change', (e) => {
                    document.body.classList.toggle('dark-theme', e.target.checked);
                    // –ú–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É –≤ localStorage
                });
            }

            // –ö–Ω–æ–ø–∫–∞ "–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏"
            if (aboutBtn) {
                aboutBtn.addEventListener('click', () => {
                    alert('–ê–Ω–æ–Ω–∏–º–Ω—ã–π —á–∞—Ç v1.0\n–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–ª—è Telegram WebApp');
                });
            }

            // –í—ã–±–æ—Ä —Ç–µ–º—ã
            themeCards.forEach(card => {
                card.addEventListener('click', () => {
                    themeCards.forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    selectedTopic = card.dataset.topic;
                });
            });

            // –ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫
            startChatBtn.addEventListener('click', () => {
                loadingOverlay.style.display = 'flex';
                
                tg.sendData(JSON.stringify({
                    action: 'search_partner',
                    topic: selectedTopic,
                    user_id: tg.initDataUnsafe?.user?.id
                }));
            });

            // –û—Ç–º–µ–Ω–∞ –ø–æ–∏—Å–∫–∞
            cancelSearchBtn.addEventListener('click', () => {
                loadingOverlay.style.display = 'none';
                tg.sendData(JSON.stringify({ action: 'cancel_search' }));
            });

            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
            function sendMessage() {
                const message = messageInput.value.trim();
                if (message && currentChatId) {
                    tg.sendData(JSON.stringify({
                        action: 'send_message',
                        chat_id: currentChatId,
                        text: message
                    }));
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                    const messageElement = document.createElement('div');
                    messageElement.className = 'message my-message';
                    messageElement.textContent = message;
                    messagesContainer.appendChild(messageElement);
                    
                    messageInput.value = '';
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }

            sendMessageBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            // –í–æ–∑–≤—Ä–∞—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é
            backToMainBtn.addEventListener('click', () => {
                chatScreen.style.display = 'none';
                document.querySelector('.container').style.display = 'flex';
                tg.sendData(JSON.stringify({ action: 'leave_chat' }));
            });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –±–æ—Ç–∞
            Telegram.WebApp.onEvent('messageReceived', (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.action === 'chat_started') {
                        currentChatId = data.chat_id;
                        loadingOverlay.style.display = 'none';
                        document.querySelector('.container').style.display = 'none';
                        chatScreen.style.display = 'flex';
                    }
                    else if (data.action === 'new_message') {
                        const messageElement = document.createElement('div');
                        messageElement.className = 'message partner-message';
                        messageElement.textContent = data.text;
                        messagesContainer.appendChild(messageElement);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                    else if (data.action === 'chat_ended') {
                        alert('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç');
                        chatScreen.style.display = 'none';
                        document.querySelector('.container').style.display = 'flex';
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', e);
                }
            });
        });
    </script>
</body>
</html>